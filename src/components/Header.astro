---
import LangSwitcher from "./LangSwitcher.astro";

const { locale, currentPath } = Astro.props;

// Navegación por idioma
const nav = {
  es: [
    ["/es", "Inicio"],
    ["/es/nosotros", "Nosotros"],
    ["/es/tratamientos", "Tratamientos"],
    ["/es/blog", "Blog"],
  ],
  ca: [
    ["/ca", "Inici"],
    ["/ca/nosotros", "Nosaltres"],          // mismo slug: /nosotros
    ["/ca/tratamientos", "Tractaments"],    // mismo slug: /tratamientos
    ["/ca/blog", "Blog"],
  ],
  en: [
    ["/en", "Home"],
    ["/en/nosotros", "About"],              // mismo slug: /nosotros
    ["/en/tratamientos", "Treatments"],     // mismo slug: /tratamientos
    ["/en/blog", "Blog"],
  ],
}[locale];

// Textos dinámicos
const texts = {
  es: {
    address: "C. de Muntaner 555, Sarrià-Sant Gervasi, Barcelona",
    phoneLabel: "Teléfono",
    bookCta: "PEDIR CITA",
    ariaLang: "Idioma",
    ariaMainNav: "Principal",
  },
  ca: {
    address: "C. de Muntaner 555, Sarrià-Sant Gervasi, Barcelona",
    phoneLabel: "Telèfon",
    bookCta: "DEMANA CITA",
    ariaLang: "Idioma",
    ariaMainNav: "Principal",
  },
  en: {
    address: "C. de Muntaner 555, Sarrià-Sant Gervasi, Barcelona",
    phoneLabel: "Phone",
    bookCta: "BOOK NOW",
    ariaLang: "Language",
    ariaMainNav: "Main",
  },
}[locale];

// Utilidades
const homeHref = nav[0][0];
const bookHref = `${homeHref}/cita`;
---

<header class="site-header">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="container topbar__inner">
      <div class="contact">
        <span class="addr">{texts.address}</span>
        <span class="sep" aria-hidden="true">|</span>
        <span class="tel">
          {texts.phoneLabel}: <span class="telnum">+34 614 37 57 92</span>
        </span>
      </div>

      <nav class="langs" aria-label={texts.ariaLang}>
        <LangSwitcher {currentPath} {locale} />
      </nav>
    </div>
  </div>

  <!-- MAINBAR -->
  <div class="mainbar">
    <div class="container mainbar__inner">
      <a href={homeHref} class="logo" aria-label="Dental Sueca">
        <img src="/assets/logo.svg" alt="Dental Sueca" />
      </a>

      <!-- Botón hamburguesa (visible en móviles) -->
      <button
        class="burger"
        aria-label="Abrir menú"
        aria-controls="mobile-menu"
        aria-expanded="false"
        data-burger
      >
        <span class="burger__bar"></span>
        <span class="burger__bar"></span>
        <span class="burger__bar"></span>
      </button>

      <!-- Navegación escritorio -->
      <nav class="nav" aria-label={texts.ariaMainNav}>
        {nav.map(([href, label]) => <a href={href}>{label}</a>)}
      </nav>

      <a class="cta" href={bookHref}>{texts.bookCta}</a>
    </div>
  </div>

  <!-- Panel móvil (oculto por defecto) -->
  <div id="mobile-menu" class="mobile-menu" hidden>
    <div class="mobile-menu__head">
      <a href={homeHref} class="mobile-logo" aria-label="Dental Sueca">
        <img src="/assets/logo.svg" alt="Dental Sueca" />
      </a>
      <button class="close" aria-label="Cerrar menú" data-close>
        ✕
      </button>
    </div>

    <nav class="mobile-nav" aria-label={texts.ariaMainNav}>
      {nav.map(([href, label]) => <a href={href} data-mobile-link>{label}</a>)}
    </nav>

    <a class="mobile-cta" href={bookHref}>{texts.bookCta}</a>
  </div>

  <!-- backdrop -->
  <div class="mobile-backdrop" hidden data-backdrop></div>
</header>

<!-- Script mínimo para toggle/escape/click-fuera -->
<script>
  const burger = document.querySelector("[data-burger]");
  const menu = document.getElementById("mobile-menu");
  const closeBtn = document.querySelector("[data-close]");
  const backdrop = document.querySelector("[data-backdrop]");
  const links = Array.from(document.querySelectorAll("[data-mobile-link]"));
  const body = document.body;

  const open = () => {
    menu.hidden = false;
    backdrop.hidden = false;
    burger.setAttribute("aria-expanded", "true");
    body.classList.add("no-scroll");
    // foco accesible al primer link
    const firstLink = menu.querySelector("a,button");
    firstLink && firstLink.focus();
  };
  const close = () => {
    menu.hidden = true;
    backdrop.hidden = true;
    burger.setAttribute("aria-expanded", "false");
    body.classList.remove("no-scroll");
    burger.focus();
  };

  burger?.addEventListener("click", () => {
    const expanded = burger.getAttribute("aria-expanded") === "true";
    expanded ? close() : open();
  });

  closeBtn?.addEventListener("click", close);
  backdrop?.addEventListener("click", close);
  links.forEach(el => el.addEventListener("click", close));

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") close();
  });
</script>

<style>
  /* ================= HEADER Responsive ================= */

.site-header .container { padding: 0 16px; } /* leve respiro en móvil */

.mainbar {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #fff;
  border-bottom: 1px solid #eef3f8;
}

.mainbar__inner{
  height: 72px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: 12px;
}

/* Nav escritorio y CTA (por defecto visibles) */
.nav{
  display: flex;
  gap: 18px;
  justify-content: center;
}
.nav a{
  text-decoration: none;
  color: var(--text-900);
  font-weight: 600;
  padding: 8px 10px;
  border-radius: 10px;
}
.nav a:hover{ background: var(--brand-50); color: var(--brand-900); }

.cta{
  display: inline-block;
  padding: 10px 14px;
  border-radius: var(--radius);
  background: var(--brand-500);
  color: #fff;
  text-decoration: none;
  font-weight: 700;
}
.cta:hover{ filter: brightness(1.05); }

/* Botón hamburguesa (oculto en desktop) */
.burger{
  display: none;
  width: 42px;
  height: 42px;
  border: 1px solid #eef3f8;
  background: #fff;
  border-radius: 12px;
  padding: 8px;
  cursor: pointer;
}
.burger__bar{
  display: block;
  height: 2px;
  background: var(--text-900);
  margin: 6px 0;
  border-radius: 2px;
}

/* Panel móvil */
.mobile-menu{
  position: fixed;
  inset: 0 0 auto 0;
  top: 0;
  height: 100dvh;
  width: min(92vw, 420px);
  background: #fff;
  border-right: 1px solid #eef3f8;
  box-shadow: 0 20px 60px rgba(0,0,0,.18);
  z-index: 2000;
  transform: translateX(-100%);
  transition: transform .25s ease;
}

.mobile-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(3, 17, 31, .35);
  backdrop-filter: blur(1px);
  z-index: 1500;
}

/* Cuando está visible (el script quita el atributo hidden) */
.mobile-menu[hidden] { transform: translateX(-100%); }
.mobile-backdrop[hidden] { display: none; }

/* Head del panel */
.mobile-menu__head{
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 8px;
  padding: 14px 16px;
  border-bottom: 1px solid #eef3f8;
}
.mobile-logo img{ height: 28px; }
.close{
  background: #fff;
  border: 1px solid #eef3f8;
  border-radius: 10px;
  width: 36px; height: 36px;
  font-size: 18px;
  cursor: pointer;
}

/* Links del panel */
.mobile-nav{
  display: grid;
  padding: 10px 10px 0 10px;
}
.mobile-nav a{
  display: block;
  padding: 12px 12px;
  margin: 6px;
  text-decoration: none;
  color: var(--text-900);
  font-weight: 600;
  border-radius: 12px;
}
.mobile-nav a:hover{ background: var(--brand-50); color: var(--brand-900); }

/* CTA del panel */
.mobile-cta{
  display: block;
  margin: 12px 16px 20px;
  text-align: center;
  padding: 14px 16px;
  border-radius: var(--radius);
  background: var(--brand-500);
  color: #fff;
  text-decoration: none;
  font-weight: 800;
  box-shadow: 0 1px 2px rgba(16,24,40,.04);
}

/* Evitar scroll del body cuando el menú está abierto */
.no-scroll { overflow: hidden; }

/* ====== BREAKPOINTS ====== */
@media (max-width: 980px){
  /* En tablets pequeñas y móviles:
     - Ocultamos nav+cta de escritorio,
     - Mostramos hamburguesa,
     - Alineamos header. */
  .nav, .cta { display: none; }
  .burger { display: inline-block; }
  .mainbar__inner{
    grid-template-columns: auto 1fr auto; /* logo | espacio | burger */
  }
  .logo img{ height: 28px; }
}

/* Afinado topbar en móvil */
@media (max-width: 640px){
  .topbar__inner{
    height: auto;
    padding: 8px 16px;
    gap: 6px;
    flex-direction: column;
    align-items: flex-start;
  }
  .topbar .sep{ display: none; }
  .contact{ font-size: 13px; }
}

</style>