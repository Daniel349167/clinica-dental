---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

/* URLs mirall: mateix slug en els 3 idiomes (tratamientos) */
const alternates = { es: "/es/tratamientos", ca: "/ca/tratamientos", en: "/en/tratamientos" };
---

<BaseLayout
  description="Descobreix tots els nostres tractaments dentals a Barcelona."
  locale="ca"
  {alternates}
>
  <Header locale="ca" currentPath="/ca/tratamientos" {alternates} />

  <!-- ========================= HERO TRACTAMENTS (CA) ========================= -->
  <section class="tr-hero" aria-label="Secci√≥ de benvinguda a Tractaments">
    <div class="tr-hero__bg"></div>
    <div class="tr-hero__inner container">
      <img class="tr-hero__mark" src="/assets/mark-hero.svg" alt="" aria-hidden="true" />
      <h1 class="tr-hero__title">
        El tractament que transformar√†<br />
        el teu somriure √©s aqu√≠
      </h1>
    </div>
  </section>

  <!-- ========================= TRACTAMENTS - SIS TARGETES ========================= -->
  <section class="tr-grid container">
    <div class="tr-grid__cards">
      <a class="tr-card" href="/ca/tratamientos/ortodoncia" aria-label="Veure tractaments d‚ÄôOrtod√≤ncia i alineadors">
        <img src="/assets/ortodoncia.svg" alt="" />
        <h3>Ortod√≤ncia i alineadors</h3>
        <p>Alineem el teu somriure amb tractaments moderns i discrets. Des de brackets est√®tics fins a ortod√≤ncia invisible.</p>
      </a>

      <a class="tr-card" href="/ca/tratamientos/implantes" aria-label="Veure tractaments d‚ÄôImplants dentals">
        <img src="/assets/implante.svg" alt="" />
        <h3>Implants dentals</h3>
        <p>Recupera la funcionalitat i l‚Äôest√®tica amb implants d‚Äô√∫ltima generaci√≥. Resultats duradors i naturals.</p>
      </a>

      <a class="tr-card" href="/ca/tratamientos/estetica-dental" aria-label="Veure tractaments d‚ÄôEst√®tica dental">
        <img src="/assets/estetica.svg" alt="" />
        <h3>Est√®tica dental</h3>
        <p>Carilles, emblanquiment i disseny de somriure per millorar l‚Äôharmonia i la lluminositat del teu rostre.</p>
      </a>

      <a class="tr-card" href="/ca/tratamientos/rehabilitacion-oral" aria-label="Veure tractaments de Rehabilitaci√≥ oral">
        <img src="/assets/rehabilitacion.svg" alt="" />
        <h3>Rehabilitaci√≥ oral</h3>
        <p>Tractament integral que combina pr√≤tesis, implants i altres t√®cniques per retornar la funcionalitat.</p>
      </a>

      <a class="tr-card" href="/ca/tratamientos/endodoncia" aria-label="Veure tractaments d‚ÄôEndod√≤ncia">
        <img src="/assets/endodoncia.svg" alt="" />
        <h3>Endod√≤ncia</h3>
        <p>Salvem dents danyades o infectades, eliminant el dolor i evitant l‚Äôextracci√≥.</p>
      </a>

      <a class="tr-card" href="/ca/tratamientos/odontopediatria" aria-label="Veure tractaments d‚ÄôOdontopediatria">
        <img src="/assets/odontopediatria.svg" alt="" />
        <h3>Odontopediatria</h3>
        <p>Tenem cura del somriure infantil amb prevenci√≥, control d‚Äôh√†bits i ortod√≤ncia primerenca.</p>
      </a>
    </div>
  </section>

  <!-- ========================= CTA (Consulta gratu√Øta) ========================= -->
  <section class="tr-cta" aria-labelledby="tr-cta-title">
    <div class="tr-cta__inner container">
      <img class="tr-cta__mark" src="/assets/mark-hero.svg" alt="" aria-hidden="true" />
      <h2 id="tr-cta-title" class="tr-cta__title">Primera consulta i diagn√≤stic gratu√Øt</h2>
      <a class="btn tr-cta__btn" href="/ca/cita" aria-label="Agenda la teva cita">AGENDA LA TEVA CITA</a>
    </div>
  </section>

  <!-- ========================= CASOS REALS (ABANS / DESPR√âS) ========================= -->
  <section class="tr-ba container">
    <h2 class="tr-ba__title">Casos reals d‚ÄôAbans i Despr√©s</h2>
    <div class="ba" data-init-ba>
      <img class="ba__before" src="/assets/casos/caso1-antes.png" alt="Antes" />
      <img class="ba__after"  src="/assets/casos/caso1-despues.png" alt="Despu√©s" />
      <input type="range" class="ba__slider" min="0" max="100" value="50" aria-label="Comparador antes/despu√©s" />
      <span class="ba__handle" aria-hidden="true"></span>
    </div>
  </section>

  <Footer locale="ca" />
</BaseLayout>

<script>
  // Solo ‚Äúoptimizaci√≥n m√≥vil‚Äù pero sin romper desktop
  const isMobile = window.matchMedia('(max-width: 640px)').matches;

  document.querySelectorAll('[data-init-ba]').forEach((ba) => {
    const slider = ba.querySelector('.ba__slider');

    // Utilidad: clamp y setter de variable CSS
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const setPct = (p) => ba.style.setProperty('--ba-x', clamp(p, 0, 100) + '%');

    // ‚úÖ Estado inicial robusto (centro)
    slider.value = 50;
    setPct(50);
    requestAnimationFrame(() => setPct(50));
    window.addEventListener('load', () => setPct(Number(slider.value) || 50), { once: true });

    // Desktop: comportamiento que ya te funciona bien
    if (!isMobile) {
      slider.addEventListener('input', (e) => setPct(e.target.value));
      ba.addEventListener('pointerdown', (ev) => {
        const rect = ba.getBoundingClientRect();
        const move = (e) => {
          const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
          const pct = (x / rect.width) * 100;
          setPct(pct);
          slider.value = Math.round(pct);
        };
        move(ev);
        const up = () => {
          window.removeEventListener('pointermove', move);
          window.removeEventListener('pointerup', up);
        };
        window.addEventListener('pointermove', move);
        window.addEventListener('pointerup', up, { once: true });
      });
      return;
    }

    // ======== üîß M√ìVIL: firme y sin jitter ========
    let dragging = false;
    let activePointerId = null;
    let pctTarget = 50;
    let pctSmoothed = 50;
    let rafId = null;

    // Suavizado EMA: alpha m√°s alto = sigue m√°s ‚Äúpegado‚Äù al dedo
    const ALPHA = 0.4; // 0.35‚Äì0.5 va bien; ajusta si quieres a√∫n m√°s firme

    const apply = () => {
      // EMA: suaviza ruido del dedo
      pctSmoothed = pctSmoothed + ALPHA * (pctTarget - pctSmoothed);

      setPct(pctSmoothed);

      // opcional: sincroniza el input sin forzar cada p√≠xel
      slider.value = Math.round(pctSmoothed);

      rafId = null;
    };

    const scheduleTo = (pct) => {
      pctTarget = clamp(pct, 0, 100);
      if (rafId == null) rafId = requestAnimationFrame(apply);
    };

    // En m√≥vil: el input puede producir jitter si tambi√©n hacemos drag
    // => S√≥lo usamos el input cuando NO estamos arrastrando
    slider.addEventListener('input', (e) => {
      if (!dragging) scheduleTo(Number(e.target.value));
    }, { passive: true });

    const startDrag = (ev) => {
      // Lock al dedo que inicia el gesto
      activePointerId = ev.pointerId ?? 'mouse';
      dragging = true;
      ba.classList.add('is-dragging');
      ba.setPointerCapture && ba.setPointerCapture(ev.pointerId);

      // Pre-c√°lculo del rect (evita jitter por reflow)
      const rect = ba.getBoundingClientRect();

      const toPct = (clientX) => {
        const x = clamp(clientX - rect.left, 0, rect.width);
        return (x / rect.width) * 100;
      };

      // Primer frame
      scheduleTo(toPct(ev.clientX));

      const onMove = (e) => {
        // Ignora otros dedos
        if ((e.pointerId ?? 'mouse') !== activePointerId) return;
        // Evita scroll ‚Äúpegajoso‚Äù que introduce ruido
        e.preventDefault?.();
        scheduleTo(toPct(e.clientX));
      };

      const endDrag = (e) => {
        if ((e.pointerId ?? 'mouse') !== activePointerId) return;
        dragging = false;
        activePointerId = null;
        ba.classList.remove('is-dragging');
        ba.releasePointerCapture && ba.releasePointerCapture(e.pointerId);
        ba.removeEventListener('pointermove', onMove);
        ba.removeEventListener('pointerup', endDrag);
        ba.removeEventListener('pointercancel', endDrag);
      };

      // Importante: no pasivos para poder preventDefault y quitar micro scrolls
      ba.addEventListener('pointermove', onMove, { passive: false });
      ba.addEventListener('pointerup', endDrag, { once: true });
      ba.addEventListener('pointercancel', endDrag, { once: true });
    };

    // Inicia el drag
    ba.addEventListener('pointerdown', (ev) => {
      // S√≥lo si el toque ocurre dentro de la zona visible
      ev.preventDefault?.();
      startDrag(ev);
    }, { passive: false });
  });
</script>

